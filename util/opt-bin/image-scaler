#!/usr/bin/env bash

# set defaults
currWd="$PWD"
wd=()
folder="thumbs"
height=0
width=0

usage="
$(basename "$0") [-d s] [-f s] [-h i] [-w i] [-H] -- scales jpgs and pngs

where:
    -d  adds a directory where the images are located (default is current directory)
    -f  specifies the relative path to destination folder (default: thumbs)
    -H  shows this help text
    -h  specifies the height of the new images
    -w  specifies the width of the new images
        It has to be set at least one dimension.
        If only one dimension is set, the other will be determined by the current ratio of the image.
"

# process options
while getopts ":d:f:Hh:w:" opt; do
    case "$opt" in
        d) wd+=($OPTARG) ;;
        f) folder=$OPTARG ;;
        H)
            echo "$usage"
            exit 0
            ;;
        h) height=$OPTARG ;;
        w) width=$OPTARG ;;
        :)
            echo "Ḿissing argument: -$OPTARG" >&2
            exit 1
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            exit 1
            ;;
    esac
done

# validate options
if [[ $height == 0 && $width == 0 ]]; then
    echo "At least one dimension option needs to be set!" >&2
    exit 1
fi

if [[ -z "$wd" ]]; then
    wd+=(".")
fi

for dir in "${wd[@]}"; do

    # change directory
    cd "$currWd" # for relative paths
    if [[ ! -d "$dir" ]]; then
        echo "Provided working directory does not exist: $dir" >&2
        continue
    fi

    cd "$dir"

    # create destination folder
    if [[ ! -d "$folder" ]]; then
        mkdir "$folder"
    fi

    if [[ $? != 0 ]]; then
        echo "Destination folder could not be created! Skipped $dir" >&2
        continue
    fi

    # convert images
    for image in *.{jpg,png}; do
        # needed íf no jpgs or pngs found
        if [[ "$image" == "*.jpg" || "$image" == "*.png" ]]; then
            continue
        fi

        # calculate size
        if [[ $height != 0 && $width != 0 ]]; then
            size="${height}x$width"
        else
            currHeight=$(identify -format "%[fx:h]" $image)
            currWidth=$(identify -format "%[fx:w]" $image)
            if [[ $height != 0 ]]; then
                widthTmp=$(($height * $currWidth / $currHeight))
                size="${height}x$widthTmp"
            else
                heightTmp=$(($width * $currHeight / $currWidth))
                size="${heightTmp}x$width"
            fi
        fi

        convert "$image" -resize "$size" "$folder/$(basename $image)"
        if [[ $? != 0 ]]; then
            echo "$(basename $image) could not be resized!" >&2
        fi

    done

done

exit 0
