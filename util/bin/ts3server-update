#!/bin/sh

DIRECTORY="${HOME}/teamspeak/"
INSTALL_DIR="${DIRECTORY}/teamspeak3-server_linux_amd64"
SERVICE="ts3server"
VERSION="${1}"

BACKUP="${INSTALL_DIR}/backup"
DOWNLOAD_FILE="/tmp/teamspeak3-server.tar.bz2"

_is_version_installed() {
    [ $(grep "Server Release ${VERSION}" "${INSTALL_DIR}/CHANGELOG" | wc -l) -gt 0 ]
}

_log() {
    echo "=> ${1}"
}


if [ -z "${VERSION}" ]; then
    _log "no version number provided"
    exit 1
fi

if [ ! -d "${DIRECTORY}" ]; then
    _log "${DIRECTORY} does not exist"
    exit 1
fi

if _is_version_installed; then
    _log "${VERSION} already installed"
    exit 1
fi

_log "stop service"
sudo service "${SERVICE}" stop

_log "save backup"
mkdir -p "${BACKUP}"
cp --backup=numbered "${INSTALL_DIR}/ts3server.sqlitedb" "${BACKUP}"

_log "download"
wget "http://dl.4players.de/ts/releases/${VERSION}/teamspeak3-server_linux_amd64-${VERSION}.tar.bz2" -O "${DOWNLOAD_FILE}"

_log "extract"
tar -xjf "${DOWNLOAD_FILE}" -C "${DIRECTORY}"

_log "clean"
rm "${DOWNLOAD_FILE}"

_log "start service"
sudo service "${SERVICE}" start

_log "test update"
if _is_version_installed; then
    _log "update successful"
else
    _log "update failed"
    exit 2
fi

exit 0
