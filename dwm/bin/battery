#!/bin/bash

# check requirements
if ! $(hash "upower" > /dev/null 2>&1); then
    echo "upower is not in PATH" >&2
    exit 2
fi


USAGE_TEXT="
$(basename "$0") <action> -- offers simple interface to battery infos

where action is one of:
    estimation    (e.g. 03:06)
    percentage    (e.g. 15)
    state         (charging|discharging|full|no battery)
"


_upower_battery() {
    upower -i $(upower -e | grep battery)
}

_return_value() {
    sed -E 's/^.*:\s+(.*)$/\1/g'
}

_format_time() {
    local hours="${1}"
    local minutes="${2}"

    printf "%02d:%02d\n" "${hours}" "${minutes}"
}

_has_battery() {
    [[ $(_upower_battery | wc -l) != 0 ]]
}

_estimation() {
    local value=$(_upower_battery \
        | grep -E "time to (empty|full):" \
        | _return_value)

    if [[ "${value}" =~ ([0-9]+)\.([0-9])\ hours ]]; then
        _format_time "${BASH_REMATCH[1]}" "$((${BASH_REMATCH[2]} * 6))"
    elif [[ "${value}" =~ ([0-9]+)\.[0-9]\ minutes ]]; then
        _format_time 0 "${BASH_REMATCH[1]}"
    fi
}

_percentage() {
    _upower_battery \
        | grep "percentage:" \
        | _return_value \
        | sed -e 's/%//g'
}

_state() {
    if _has_battery; then
        local value=$(_upower_battery \
            | grep "state:" \
            | _return_value)

        if [[ "${value}" == "fully-charged" ]]; then
            echo "full"
        else
            echo "${value}"
        fi
    else
        echo "no battery"
    fi
}

_usage() {
    echo "${USAGE_TEXT}"
}

case "${1}" in
    estimation) _estimation      ;;
    percentage) _percentage      ;;
    state)      _state           ;;
    *)          _usage && exit 1 ;;
esac

exit 0
