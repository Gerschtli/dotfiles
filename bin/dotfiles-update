#!/bin/bash -e

source "$(dirname "$0")/../util/dotfiles-variables.symlink"
source "${DOTFILES_ROOT}/util/script-functions"

_d_indent() {
    while IFS= read -r line; do
        printf "     > %s\n" "${line}"
    done < <($@ 2>&1)
}

_d_pull() {
    _d_info "git fetch --prune ..."
    _d_indent git fetch --prune

    if [[ $(git rev-parse --abbrev-ref HEAD) != "master" ]]; then
        _d_info "git checkout master ..."
        _d_indent git checkout master
    fi

    if [[ $(git diff --name-only) != "" ]]; then
        local stash=true
        _d_info "git stash ..."
        _d_indent git stash
    fi

    _d_info "git rebase origin/master ..."
    _d_indent git -c color.diff=always rebase origin/master

    if [[ ! -z "${stash}" ]]; then
        _d_info "git stash pop ..."
        _d_indent git -c color.status=always stash pop
    fi
}

pushd "${DOTFILES_ROOT}" 1> /dev/null

if [[ -z "${1}" ]]; then
    _d_info "========= DOTFILES ========="
    _d_pull

    if [[ -d "ssh" ]]; then
        pushd "ssh" 1> /dev/null
        echo
        _d_info "============ SSH ==========="
        _d_pull
        popd 1> /dev/null
    fi
fi

if available termux-fix-shebang; then
    echo
    _d_info "==== TERMUX FIX SHEBANG ===="
    _d_indent termux-fix-shebang bootstrap.sh bin/*
fi

echo
_d_info "========= BOOTSTRAP ========"
_d_indent ./bootstrap.sh

popd 1> /dev/null

exit 0
