#!/usr/bin/env bash
set -e

source "$(dirname "$0")/../util/dotfiles-variables.symlink"
source "${DOTFILES_ROOT}/util/script-functions"

if [[ -z "${1}" ]]; then
    _d_info "========= DOTFILES ========="
    _d_pull "${DOTFILES_ROOT}"

    if [[ -d "${DOTFILES_ROOT}/gpg" ]]; then
        echo
        _d_info "============ GPG ==========="
        _d_pull "${DOTFILES_ROOT}/gpg"
    fi

    for ssh_module in "${DOTFILES_ROOT}/ssh/modules/"*; do
        echo
        _d_info "======== SSH $(basename "${ssh_module}") ========"
        _d_pull "${ssh_module}"
    done

    echo
    _d_info "===== SUBMOUDLE UPDATE ====="
    _d_indent git -C "${DOTFILES_ROOT}" submodule update --init
    _d_indent git -C "${DOTFILES_ROOT}" submodule foreach git checkout master
    _d_indent git -C "${DOTFILES_ROOT}" submodule foreach git pull
fi

if available termux-fix-shebang; then
    echo
    _d_info "==== TERMUX FIX SHEBANG ===="
    _d_indent termux-fix-shebang "${DOTFILES_ROOT}"/{bootstrap.sh,*/bin/*,git/git-templates.symlink/hooks/{pre,post-,scripts/}*}
fi

echo
_d_info "========= BOOTSTRAP ========"
_d_indent "${DOTFILES_ROOT}/bootstrap.sh"
