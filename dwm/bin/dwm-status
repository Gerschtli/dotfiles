#!/bin/bash

BATTERY_BIN="battery"
LOG_FILE="${HOME}/.dwm-status-errors"

function _log {
    echo "${1}" >> "${LOG_FILE}"
}

function _backlight {
    printf "L: %.0f%%" "$(xbacklight)"
}

function _battery {
    local state="$($BATTERY_BIN state)"

    case "${state}" in
        full)
            echo "= 100%"
            ;;
        "no battery")
            echo "NO BATT"
            ;;
        charging|discharging)
            local estimation="$($BATTERY_BIN estimation)"
            local percentage="$($BATTERY_BIN percentage)"

            local icon="↑"
            if [[ "${state}" == "discharging" ]]; then
                icon="↓"
            fi

            printf "%s %d%% (%s)" "${icon}" "${percentage}" "${estimation}"
            ;;
        *)
            _log $'\n=========================\n'
            _log "$(upower -i $(upower -e | grep battery))"
            ;;
    esac
}

function _datetime {
    echo "$(date "+%EY-%m-%d %H:%M")"
}

function _sound {
    local amixer_output="$(amixer get Master | grep "Front Left: Playback")"

    local regex="\[([0-9]+)%\] \[(on|off)\]$"

    if [[ "${amixer_output}" =~ ${regex} ]]; then
        local percent="${BASH_REMATCH[1]}"
        local state="${BASH_REMATCH[2]}"

        if [[ "${state}" == "on" ]]; then
            printf "S: ${percent}%%"
        else
            printf "S: MUTE"
        fi
    else
        _log "sound: ${amixer_output}"
    fi
}

echo "$(_backlight) | $(_sound) | $(_battery) | $(_datetime)"
