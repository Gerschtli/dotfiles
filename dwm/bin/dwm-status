#!/usr/bin/env bash

BATTERY_BIN="battery"
LOG_FILE="${HOME}/.dwm-status-errors"
SEPARATOR="|"

_log() {
    echo "${1}" >> "${LOG_FILE}"
}

_build_element() {
    if [[ ! -z "${1}" ]]; then
        echo "${1} ${SEPARATOR} "
    fi
}

_backlight() {
    if $(hash xbacklight > /dev/null 2>&1); then
        printf "L: %.0f%%" "$(xbacklight)"
    fi
}

_battery() {
    local state="$($BATTERY_BIN state 2> /dev/null)"
    if [[ $? == 2 ]]; then
        return
    fi

    case "${state}" in
        full)
            echo "= 100%"
            ;;
        "no battery")
            echo "NO BATT"
            ;;
        charging|discharging)
            local estimation="$($BATTERY_BIN estimation)"
            local percentage="$($BATTERY_BIN percentage)"

            local icon="↑"
            if [[ "${state}" == "discharging" ]]; then
                icon="↓"
            fi

            printf "%s %d%% (%s)" "${icon}" "${percentage}" "${estimation}"
            ;;
        *)
            _log $'\n=========================\n'
            _log "$(upower -i $(upower -e | grep battery))"
            ;;
    esac
}

_datetime() {
    echo "$(date "+%EY-%m-%d %H:%M")"
}

_sound() {
    local amixer_output="$(amixer get Master | grep "Front Left: Playback")"

    local regex="\[([0-9]+)%\] \[(on|off)\]$"

    if [[ "${amixer_output}" =~ ${regex} ]]; then
        local percent="${BASH_REMATCH[1]}"
        local state="${BASH_REMATCH[2]}"

        if [[ "${state}" == "on" ]]; then
            printf "S: ${percent}%%"
        else
            printf "S: MUTE"
        fi
    else
        _log $'\n=========================\n'
        _log "$(amixer)"
    fi
}

echo -n "$(_build_element "$(_backlight)")"
echo -n "$(_build_element "$(_sound)")"
echo -n "$(_build_element "$(_battery)")"
echo -n "$(_datetime)"
